<!DOCTYPE html>
<html lang="pt-PT" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MozartDev - AI Builder Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/appwrite@13.0.1"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    animation: {
                        'bounce-slow': 'bounce 3s infinite',
                        'fade-in-up': 'fadeInUp 0.5s ease-out forwards',
                        'pulse-fast': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        fadeInUp: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap');
        
        :root {
            --background: 0 0% 100%;
            --foreground: 222.2 84% 4.9%;
            --border: 214.3 31.8% 91.4%;
        }

        .dark {
            --background: 222.2 84% 4.9%;
            --foreground: 210 40% 98%;
            --border: 217.2 32.6% 17.5%;
        }

        body { font-family: 'Plus Jakarta Sans', sans-serif; }
        
        .chat-scroll::-webkit-scrollbar { width: 4px; }
        .chat-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .dark .chat-scroll::-webkit-scrollbar-thumb { background: #334155; }

        .glass-card { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); }
        .dark .glass-card { background: rgba(15, 23, 42, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.05); }

        .code-block { background: #0f172a; color: #e2e8f0; padding: 1rem; border-radius: 1rem; font-family: 'Fira Code', monospace; font-size: 0.8rem; overflow-x: auto; position: relative; border: 1px solid rgba(255,255,255,0.1); margin-top: 1rem; }
        
        .btn-action { font-size: 0.7rem; padding: 8px 14px; border-radius: 8px; font-weight: 700; display: flex; align-items: center; gap: 6px; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .btn-action:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }

        /* Thinking Animation */
        .typing-dot { width: 6px; height: 6px; background: currentColor; border-radius: 50%; opacity: 0.4; animation: typing 1s infinite; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing { 0%, 100% { transform: translateY(0); opacity: 0.4; } 50% { transform: translateY(-4px); opacity: 1; } }

        .canvas-transition { transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
    </style>
</head>
<body class="bg-slate-50 dark:bg-slate-950 text-slate-900 dark:text-slate-100 transition-colors duration-300">

    <!-- Notificações -->
    <div id="toast" class="fixed top-20 right-5 z-[110] transform translate-x-full transition-transform duration-300">
        <div id="toast-content" class="px-6 py-3 rounded-2xl shadow-2xl text-white font-bold text-sm"></div>
    </div>

    <!-- Barra de Navegação Superior -->
    <nav class="fixed top-0 left-0 right-0 h-16 bg-white/80 dark:bg-slate-900/80 backdrop-blur-md z-50 border-b border-slate-200 dark:border-slate-800 flex items-center justify-between px-6">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-indigo-600 rounded-2xl flex items-center justify-center text-white shadow-lg shadow-indigo-500/30 animate-pulse-fast">
                <i class="fas fa-bolt"></i>
            </div>
            <div>
                <h1 class="font-bold text-lg leading-tight">Mozart<span class="text-indigo-600">Dev</span></h1>
                <p class="text-[9px] uppercase tracking-widest font-bold opacity-40">Intelligence Builder</p>
            </div>
        </div>

        <div class="flex items-center gap-2">
            <button onclick="toggleDarkMode()" class="w-10 h-10 flex items-center justify-center rounded-xl hover:bg-slate-100 dark:hover:bg-slate-800 transition-all text-slate-500">
                <i class="fas fa-moon dark:hidden"></i>
                <i class="fas fa-sun hidden dark:block text-amber-400"></i>
            </button>
            <button onclick="toggleModal('settings-modal')" class="w-10 h-10 flex items-center justify-center rounded-xl hover:bg-slate-100 dark:hover:bg-slate-800 transition-all text-slate-500">
                <i class="fas fa-key"></i>
            </button>
            <div id="auth-controls">
                <button onclick="toggleModal('auth-modal')" class="bg-slate-900 dark:bg-white dark:text-slate-900 text-white px-5 py-2 rounded-xl text-xs font-bold hover:scale-105 transition-all">Aceder</button>
            </div>
            <div id="user-profile" class="hidden flex items-center gap-2 bg-slate-100 dark:bg-slate-800 p-1.5 rounded-xl border border-slate-200 dark:border-slate-700">
                <div id="user-avatar" class="w-7 h-7 rounded-lg bg-indigo-600 flex items-center justify-center text-white font-bold text-[10px]"></div>
                <button onclick="logout()" class="text-slate-400 hover:text-red-500 transition-colors px-1"><i class="fas fa-sign-out-alt text-xs"></i></button>
            </div>
        </div>
    </nav>

    <!-- Estrutura Principal -->
    <div class="flex h-screen pt-16 overflow-hidden">
        
        <!-- Painel de Chat -->
        <aside id="chat-panel" class="w-full lg:w-1/2 flex flex-col border-r border-slate-200 dark:border-slate-800 relative bg-white dark:bg-slate-950 canvas-transition">
            <div id="chat-messages" class="flex-1 overflow-y-auto p-6 space-y-6 chat-scroll pb-32">
                <!-- Welcome Msg -->
                <div class="flex gap-4 items-start animate-fade-in-up">
                    <div class="w-10 h-10 rounded-2xl bg-indigo-600 text-white flex items-center justify-center flex-shrink-0 shadow-lg">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="glass-card p-5 rounded-3xl max-w-[85%] shadow-sm">
                        <p class="text-sm leading-relaxed">
                            Olá! Eu sou o Mozart IA. <br><br>
                            Agora sou mais inteligente: podes conversar comigo normalmente. Se quiseres que eu crie um site ou componente, basta pedires!
                        </p>
                    </div>
                </div>
            </div>

            <!-- Input Area -->
            <div class="absolute bottom-0 left-0 right-0 p-6 bg-gradient-to-t from-white dark:from-slate-950 via-white/90 dark:via-slate-950/90 to-transparent">
                <div class="max-w-3xl mx-auto">
                    <div class="relative flex items-end bg-slate-100 dark:bg-slate-900 rounded-3xl border border-slate-200 dark:border-slate-800 p-2 focus-within:ring-2 focus-within:ring-indigo-500/30 transition-all shadow-xl shadow-indigo-500/5">
                        <textarea id="user-input" rows="1" oninput="autoResize(this)" class="flex-1 bg-transparent px-4 py-3 resize-none focus:outline-none text-sm min-h-[44px] max-h-[200px]" placeholder="Diz 'Olá' ou pede um site..."></textarea>
                        <button id="send-btn" onclick="sendMessage()" class="w-11 h-11 bg-indigo-600 text-white rounded-2xl flex items-center justify-center hover:scale-105 active:scale-95 transition-all disabled:opacity-50 shadow-lg shadow-indigo-600/20">
                            <i class="fas fa-paper-plane text-sm"></i>
                        </button>
                    </div>
                    <div class="flex justify-between items-center px-4 mt-3">
                        <select id="model-select" class="bg-transparent text-[10px] font-black text-slate-400 uppercase tracking-widest outline-none cursor-pointer hover:text-indigo-500 transition-colors">
                            <option value="gemini">Google Gemini 2.5</option>
                            <option value="openai">OpenAI GPT-4o</option>
                        </select>
                        <span class="text-[9px] text-slate-400 font-bold uppercase tracking-tighter"><i class="fas fa-shield-alt mr-1"></i> Blindagem Ativa</span>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Painel de Canvas (Oculto em Mobile por defeito) -->
        <main id="canvas-panel" class="hidden lg:flex lg:w-1/2 flex-col bg-slate-100 dark:bg-slate-900 relative canvas-transition">
            <div class="h-12 flex items-center justify-between px-6 bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700">
                <div class="flex gap-2">
                    <div class="w-3 h-3 rounded-full bg-red-400"></div>
                    <div class="w-3 h-3 rounded-full bg-amber-400"></div>
                    <div class="w-3 h-3 rounded-full bg-green-400"></div>
                </div>
                <div class="flex items-center gap-2 text-[10px] font-black text-slate-400 uppercase tracking-widest">
                    <i class="fas fa-eye text-indigo-500"></i> Live Preview
                </div>
                <button onclick="clearCanvas()" class="text-slate-400 hover:text-red-500 transition-colors"><i class="fas fa-sync-alt text-xs"></i></button>
            </div>
            <div class="flex-1 p-6 flex flex-col">
                <div class="flex-1 bg-white dark:bg-slate-950 rounded-3xl overflow-hidden shadow-2xl relative border border-slate-200 dark:border-slate-800">
                    <iframe id="canvas-iframe" class="w-full h-full border-none"></iframe>
                    <div id="canvas-empty" class="absolute inset-0 flex flex-col items-center justify-center text-slate-200 dark:text-slate-800">
                        <i class="fas fa-laptop-code text-8xl mb-6 animate-bounce-slow"></i>
                        <p class="text-sm font-bold tracking-widest uppercase opacity-50">Aguardando código...</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modais -->
    <div id="settings-modal" class="hidden fixed inset-0 bg-slate-950/60 backdrop-blur-md z-[200] flex items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-900 w-full max-w-md rounded-[2.5rem] p-8 shadow-2xl animate-fade-in-up">
            <div class="flex justify-between items-center mb-8">
                <h3 class="font-bold text-2xl tracking-tight">API Settings</h3>
                <button onclick="toggleModal('settings-modal')" class="w-10 h-10 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 flex items-center justify-center"><i class="fas fa-times"></i></button>
            </div>
            <div class="space-y-5">
                <div class="space-y-2">
                    <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Gemini Key</label>
                    <input type="password" id="key-gemini" placeholder="AIza..." class="w-full bg-slate-100 dark:bg-slate-800 border-none rounded-2xl p-4 text-sm focus:ring-2 focus:ring-indigo-500 transition-all outline-none">
                </div>
                <div class="space-y-2">
                    <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">OpenAI Key</label>
                    <input type="password" id="key-openai" placeholder="sk-..." class="w-full bg-slate-100 dark:bg-slate-800 border-none rounded-2xl p-4 text-sm focus:ring-2 focus:ring-indigo-500 transition-all outline-none">
                </div>
            </div>
            <button onclick="saveKeys()" class="w-full bg-indigo-600 text-white font-black py-5 rounded-2xl mt-8 hover:bg-indigo-700 shadow-xl shadow-indigo-500/20 transition-all">Guardar Configurações</button>
        </div>
    </div>

    <div id="auth-modal" class="hidden fixed inset-0 bg-slate-950/60 backdrop-blur-md z-[200] flex items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-900 w-full max-w-sm rounded-[2.5rem] p-8 shadow-2xl animate-fade-in-up">
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-indigo-100 dark:bg-indigo-900/30 text-indigo-600 rounded-3xl flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-user-shield text-2xl"></i>
                </div>
                <h3 id="auth-title" class="font-bold text-2xl">Acesso Blindado</h3>
                <p class="text-slate-400 text-xs mt-2">Faz login para ativar o Builder Mode.</p>
            </div>
            <div class="space-y-4">
                <input type="email" id="auth-email" placeholder="Email" class="w-full bg-slate-100 dark:bg-slate-800 rounded-2xl p-4 text-sm outline-none border-none focus:ring-2 focus:ring-indigo-500">
                <input type="password" id="auth-pass" placeholder="Senha" class="w-full bg-slate-100 dark:bg-slate-800 rounded-2xl p-4 text-sm outline-none border-none focus:ring-2 focus:ring-indigo-500">
                <button onclick="handleAuth()" id="auth-btn" class="w-full bg-indigo-600 text-white font-bold py-5 rounded-2xl hover:bg-indigo-700 transition-all shadow-xl">Aceder</button>
                <button onclick="toggleAuthMode()" id="auth-toggle" class="w-full text-[10px] font-black text-slate-400 uppercase tracking-widest hover:text-indigo-600">Criar uma conta nova</button>
            </div>
        </div>
    </div>

    <script>
        const client = new Appwrite.Client().setEndpoint('https://nyc.cloud.appwrite.io/v1').setProject('696bf27100194d72c011');
        const account = new Appwrite.Account(client);
        const databases = new Appwrite.Databases(client);
        const DATABASE_ID = 'ai_db';
        const TABLE_ID = 'backups';
        
        let currentUser = null;
        let isLoginMode = true;

        window.onload = async () => {
            initTheme();
            loadKeys();
            try {
                currentUser = await account.get();
                updateUI();
            } catch (e) { console.log("Guest mode."); }
        };

        function initTheme() {
            if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            }
        }

        function toggleDarkMode() {
            document.documentElement.classList.toggle('dark');
            localStorage.theme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
        }

        function toggleModal(id) {
            document.getElementById(id).classList.toggle('hidden');
        }

        function toggleAuthMode() {
            isLoginMode = !isLoginMode;
            document.getElementById('auth-title').innerText = isLoginMode ? 'Acesso Blindado' : 'Novo Registo';
            document.getElementById('auth-btn').innerText = isLoginMode ? 'Aceder' : 'Criar Conta';
        }

        function updateUI() {
            document.getElementById('auth-controls').classList.add('hidden');
            document.getElementById('user-profile').classList.remove('hidden');
            document.getElementById('user-avatar').innerText = currentUser.email.charAt(0).toUpperCase();
            if(!document.getElementById('auth-modal').classList.contains('hidden')) toggleModal('auth-modal');
        }

        function saveKeys() {
            const keys = { gemini: document.getElementById('key-gemini').value, openai: document.getElementById('key-openai').value };
            localStorage.setItem('mozart_pro_keys', JSON.stringify(keys));
            showNotify("Conexões atualizadas!", "bg-indigo-600");
            toggleModal('settings-modal');
        }

        function loadKeys() {
            const saved = localStorage.getItem('mozart_pro_keys');
            if (saved) {
                const keys = JSON.parse(saved);
                document.getElementById('key-gemini').value = keys.gemini || "";
                document.getElementById('key-openai').value = keys.openai || "";
            }
        }

        // CHAT ENGINE
        async function sendMessage() {
            const input = document.getElementById('user-input');
            const text = input.value.trim();
            const model = document.getElementById('model-select').value;
            if (!text) return;

            appendMsg('user', text);
            input.value = "";
            input.style.height = "auto";
            input.disabled = true;
            document.getElementById('send-btn').disabled = true;

            // Mostrar Indicador de Digitação
            const thinkingId = appendThinking();

            try {
                const keys = JSON.parse(localStorage.getItem('mozart_pro_keys') || "{}");
                let aiText = "";

                // NOVO PROMPT: Conversacional
                const systemPrompt = "És o Mozart IA, um assistente inteligente e amigável. Se o utilizador apenas disser 'Olá' ou conversar, responde normalmente com texto. APENAS se o utilizador pedir explicitamente para criares um site, componente ou código, deves gerar um bloco de código usando ```html e Tailwind CSS.";

                if (model === 'gemini') {
                    if (!keys.gemini) throw new Error("Configura a Gemini Key.");
                    aiText = await fetchGemini(text, keys.gemini, systemPrompt);
                } else {
                    if (!keys.openai) throw new Error("Configura a OpenAI Key.");
                    aiText = await fetchOpenAI(text, keys.openai, systemPrompt);
                }

                removeThinking(thinkingId);
                appendMsg('ai', aiText);
            } catch (e) {
                removeThinking(thinkingId);
                appendMsg('ai', `⚠️ **Erro:** ${e.message}`);
            } finally {
                input.disabled = false;
                document.getElementById('send-btn').disabled = false;
                input.focus();
            }
        }

        async function fetchGemini(prompt, key, system) {
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }],
                    systemInstruction: { parts: [{ text: system }] }
                })
            });
            const data = await res.json();
            return data.candidates?.[0]?.content?.parts?.[0]?.text || "Erro na resposta.";
        }

        async function fetchOpenAI(prompt, key, system) {
            const res = await fetch(`https://api.openai.com/v1/chat/completions`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${key}` },
                body: JSON.stringify({
                    model: "gpt-4o",
                    messages: [{ role: "system", content: system }, { role: "user", content: prompt }]
                })
            });
            const data = await res.json();
            if(data.error) throw new Error(data.error.message);
            return data.choices[0].message.content;
        }

        // UI HELPERS
        function appendMsg(role, text) {
            const chat = document.getElementById('chat-messages');
            const wrap = document.createElement('div');
            wrap.className = `flex gap-4 items-start ${role === 'user' ? 'flex-row-reverse animate-fade-in-up' : 'animate-fade-in-up'}`;

            const icon = role === 'ai' ? 'fas fa-robot' : 'fas fa-user';
            const iconColor = role === 'ai' ? 'text-indigo-600' : 'text-slate-400';
            const bg = role === 'ai' ? 'glass-card border-slate-200 dark:border-slate-800' : 'bg-indigo-600 text-white border-indigo-500';

            let content = text;
            if (role === 'ai') {
                content = text.replace(/```html\n([\s\S]*?)```/g, (match, code) => {
                    const encoded = btoa(unescape(encodeURIComponent(code)));
                    return `
                        <div class="code-block group">
                            <pre><code>${code.replace(/</g, '&lt;')}</code></pre>
                            <div class="flex gap-2 mt-4">
                                <button onclick="runInCanvas('${encoded}')" class="btn-action bg-indigo-500 text-white"><i class="fas fa-play"></i> Visualizar</button>
                                ${currentUser ? `<button onclick="saveToAppwrite('${encoded}')" class="btn-action bg-slate-700 text-white"><i class="fas fa-save"></i> Backup</button>` : ''}
                            </div>
                        </div>
                    `;
                });
            }

            wrap.innerHTML = `
                <div class="w-10 h-10 rounded-2xl bg-slate-100 dark:bg-slate-800 flex items-center justify-center flex-shrink-0 shadow-sm border border-slate-200 dark:border-slate-700">
                    <i class="${icon} ${iconColor}"></i>
                </div>
                <div class="${bg} p-5 rounded-[2rem] shadow-sm border max-w-[85%] text-sm leading-relaxed">
                    ${content.replace(/\n/g, '<br>')}
                </div>
            `;
            
            chat.appendChild(wrap);
            chat.scrollTop = chat.scrollHeight;
        }

        function appendThinking() {
            const id = 'thinking-' + Date.now();
            const chat = document.getElementById('chat-messages');
            const wrap = document.createElement('div');
            wrap.id = id;
            wrap.className = "flex gap-4 items-start animate-fade-in-up";
            wrap.innerHTML = `
                <div class="w-10 h-10 rounded-2xl bg-indigo-50 dark:bg-indigo-900/20 text-indigo-400 flex items-center justify-center flex-shrink-0">
                    <i class="fas fa-brain animate-pulse"></i>
                </div>
                <div class="glass-card p-4 rounded-3xl flex gap-1 items-center">
                    <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>
                </div>
            `;
            chat.appendChild(wrap);
            chat.scrollTop = chat.scrollHeight;
            return id;
        }

        function removeThinking(id) {
            const el = document.getElementById(id);
            if (el) el.remove();
        }

        function runInCanvas(encoded) {
            const code = decodeURIComponent(escape(atob(encoded)));
            const iframe = document.getElementById('canvas-iframe');
            document.getElementById('canvas-empty').classList.add('hidden');
            
            const fullCode = `<html><head><script src="https://cdn.tailwindcss.com"><\/script><style>body { margin: 0; padding: 20px; }</style></head><body>${code}</body></html>`;
            iframe.srcdoc = fullCode;
            showNotify("A carregar no Canvas...", "bg-indigo-600");
        }

        function clearCanvas() {
            document.getElementById('canvas-iframe').srcdoc = "";
            document.getElementById('canvas-empty').classList.remove('hidden');
        }

        async function saveToAppwrite(encoded) {
            const code = decodeURIComponent(escape(atob(encoded)));
            const name = prompt("Nome do projeto:");
            if(!name) return;
            try {
                await databases.createDocument(DATABASE_ID, TABLE_ID, Appwrite.ID.unique(), { userId: currentUser.$id, siteName: name, content: code }, [Appwrite.Permission.read(Appwrite.Role.user(currentUser.$id)), Appwrite.Permission.update(Appwrite.Role.user(currentUser.$id)), Appwrite.Permission.delete(Appwrite.Role.user(currentUser.$id))]);
                showNotify("Blindado com sucesso!", "bg-green-600");
            } catch (e) { showNotify(e.message, "bg-red-500"); }
        }

        async function handleAuth() {
            const email = document.getElementById('auth-email').value;
            const pass = document.getElementById('auth-pass').value;
            try {
                if(isLoginMode) { await account.createEmailSession(email, pass); }
                else { await account.create(Appwrite.ID.unique(), email, pass, "Developer"); await account.createEmailSession(email, pass); }
                location.reload();
            } catch (e) { showNotify(e.message, "bg-red-500"); }
        }

        async function logout() { await account.deleteSession('current'); location.reload(); }
        function autoResize(el) { el.style.height = "auto"; el.style.height = (el.scrollHeight) + "px"; }
        function showNotify(msg, color) {
            const toast = document.getElementById('toast');
            const content = document.getElementById('toast-content');
            content.className = `px-6 py-3 rounded-2xl shadow-2xl text-white font-bold text-xs ${color}`;
            content.innerText = msg;
            toast.classList.remove('translate-x-full');
            setTimeout(() => toast.classList.add('translate-x-full'), 3000);
        }
    </script>
</body>
</html>
